name: Compile LaTeX and Deploy to CV Repo

on:
  push:
    branches:
      - main
    paths:
      - 'curriculum_vitae/**/*.tex'
      - 'curriculum_vitae/**/*.cls'
      - '.github/workflows/compile-latex.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'curriculum_vitae/**/*.tex'
      - 'curriculum_vitae/**/*.cls'

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout applications-repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compile SWE Resume
        uses: xu-cheng/latex-action@v3
        with:
          root_file: swe-resume.tex
          working_directory: curriculum_vitae
          compiler: xelatex
          args: -file-line-error -halt-on-error -interaction=nonstopmode

      - name: Compile Quant Resume
        uses: xu-cheng/latex-action@v3
        with:
          root_file: quant-resume.tex
          working_directory: curriculum_vitae
          compiler: xelatex
          args: -file-line-error -halt-on-error -interaction=nonstopmode

      - name: List compiled PDFs
        run: ls -lh curriculum_vitae/*.pdf

      - name: Checkout cv-repo (public)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/checkout@v4
        with:
          repository: LevRoz630/cv-repo
          token: ${{ secrets.CV_REPO_TOKEN }}
          path: cv-repo

      - name: Copy PDFs to cv-repo
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          mkdir -p cv-repo/docs
          cp curriculum_vitae/swe-resume.pdf cv-repo/docs/ || echo "SWE PDF not found"
          cp curriculum_vitae/quant-resume.pdf cv-repo/docs/ || echo "Quant PDF not found"
          ls -lh cv-repo/docs/

      - name: Commit and push to cv-repo
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          cd cv-repo
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/*.pdf
          git diff --staged --quiet || git commit -m "Auto-compile LaTeX CVs from applications-repo"
          git push
